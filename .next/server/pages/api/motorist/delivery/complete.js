"use strict";(()=>{var e={};e.id=8744,e.ids=[8744],e.modules={53524:e=>{e.exports=require("@prisma/client")},99344:e=>{e.exports=require("jsonwebtoken")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},5503:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{config:()=>l,default:()=>u,routeModule:()=>c});var s=i(71802),a=i(47153),r=i(56249),o=i(83277),d=e([o]);o=(d.then?(await d)():d)[0];let u=(0,r.l)(o,"default"),l=(0,r.l)(o,"config"),c=new s.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/motorist/delivery/complete",pathname:"/api/motorist/delivery/complete",bundlePath:"",filename:""},userland:o});n()}catch(e){n(e)}})},83277:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{default:()=>u});var s=i(53524),a=i(9926),r=i(99344),o=i.n(r),d=e([a]);a=(d.then?(await d)():d)[0];let l=new s.PrismaClient,c=a.z.object({deliveryId:a.z.string().min(1,"Delivery ID is required"),totalDistance:a.z.number().min(0,"Total distance must be a positive number"),totalCost:a.z.number().min(0,"Total cost must be a positive number"),status:a.z.enum(["PENDING","ASSIGNED","PICKED_UP","IN_TRANSIT","DELIVERED","CANCELLED"]),endTime:a.z.string().min(1,"End time is required"),destination:a.z.string().min(1,"destination location is required"),destinationLat:a.z.number().min(1,"destination latitude location is required"),destinationLong:a.z.number().min(1,"destination longitude is required")}),m=e=>{try{return o().verify(e,process.env.JWT_SECRET_KEY)}catch(e){return console.error("Token validation failed:",e),null}};async function u(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let i=e.headers.authorization?.split(" ")[1]||e.cookies.session_token;if(!i)return t.status(401).json({message:"Unauthorized: No token provided"});if(!m(i))return t.status(401).json({message:"Unauthorized: Invalid token"});let n=c.parse(e.body),s=await l.delivery.findUnique({where:{id:n.deliveryId}});if(!s)return t.status(404).json({message:"Delivery not found"});if(!s.motoristId)return t.status(400).json({message:"Delivery has no assigned motorist"});if("DELIVERED"===s.status||"CANCELLED"===s.status)return t.status(400).json({message:"Delivery is already completed or cancelled"});let a=s.endLocationId;"DELIVERED"===n.status&&n.destination&&n.destinationLat&&n.destinationLong&&(a=(await l.location.create({data:{name:n.destination,address:n.destination,latitude:n.destinationLat,longitude:n.destinationLong}})).id);let r=await l.delivery.update({where:{id:n.deliveryId},data:{distance:n.totalDistance,fee:n.totalCost,status:n.status,endTime:new Date(n.endTime),endLocationId:a}}),o=!1;("DELIVERED"===n.status||"CANCELLED"===n.status)&&(o=!0),await l.motorist.update({where:{id:s.motoristId},data:{isAvailable:o}}),t.status(200).json({message:"Delivery updated successfully",delivery:{id:r.id,status:r.status,totalDistance:r.distance,totalCost:r.fee}})}catch(e){if(console.error("Error updating delivery:",e),e instanceof a.z.ZodError)return t.status(400).json({message:"Validation failed",errors:e.errors});if(e instanceof o().JsonWebTokenError)return t.status(401).json({message:"Unauthorized: Invalid token"});t.status(500).json({message:"Internal server error"})}}n()}catch(e){n(e)}})},47153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},71802:(e,t,i)=>{e.exports=i(20145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var i=t(t.s=5503);module.exports=i})();