"use strict";(()=>{var e={};e.id=403,e.ids=[403],e.modules={53524:e=>{e.exports=require("@prisma/client")},99344:e=>{e.exports=require("jsonwebtoken")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9926:e=>{e.exports=import("zod")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},94473:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>d,routeModule:()=>c});var o=r(71802),i=r(47153),a=r(56249),s=r(25074),u=e([s]);s=(u.then?(await u)():u)[0];let d=(0,a.l)(s,"default"),l=(0,a.l)(s,"config"),c=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/motorist/delivery/delivery-history",pathname:"/api/motorist/delivery/delivery-history",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},25074:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>d});var o=r(53524),i=r(9926),a=r(99344),s=r.n(a),u=e([i]);i=(u.then?(await u)():u)[0];let l=new o.PrismaClient,c=i.z.object({motoristId:i.z.string().min(1,"Motorist ID is required"),page:i.z.string().min(1,"Page number is required").transform(Number),data:i.z.string().min(1,"Data per page is required").transform(Number)}),m=e=>{try{return s().verify(e,process.env.JWT_SECRET_KEY)}catch(e){return console.error("Token validation failed:",e),null}};async function d(e,t){if("GET"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let r=e.headers.authorization?.split(" ")[1]||e.cookies.session_token;if(!r)return t.status(401).json({message:"Unauthorized: No token provided"});let n=m(r);if(!n)return t.status(401).json({message:"Unauthorized: Invalid token"});let{motoristId:o,page:i,data:a}=c.parse(e.query),s=(i-1)*a;console.log(`Fetching deliveries for motorist: ${o}, page: ${i}, per page: ${a}`);let u=await l.motorist.findUnique({where:{id:o}});if(!u)return t.status(404).json({message:"Motorist not found"});if(u.userId!==n.userId)return t.status(403).json({message:"Forbidden: You do not have permission to access this motorist"});let d=(await l.delivery.findMany({where:{motoristId:o},skip:s,take:a,include:{startLocation:!0,endLocation:!0,customer:!0},orderBy:{createdAt:"desc"}})).map(e=>({totalDistance:e.distance,source:e.startLocation.name,destination:e.endLocation?.name??null,totalCost:e.fee,status:e.status,sourceLat:e.startLocation.latitude,sourceLong:e.startLocation.longitude,destinationLat:e.endLocation?.latitude??null,destinationLong:e.endLocation?.longitude??null,startTime:e.startTime?.toISOString()??null,endTime:e.endTime?.toISOString()??null,customerPhone:e.customer?.phonenumber??null})),f=await l.delivery.count({where:{motoristId:o}});return t.status(200).json({data:d,pagination:{currentPage:i,itemsPerPage:a,totalItems:f,totalPages:Math.ceil(f/a)}})}catch(e){if(console.error("Error fetching delivery history:",e),e instanceof i.z.ZodError)return t.status(400).json({message:"Validation failed",errors:e.errors.map(e=>({path:e.path.join("."),message:e.message}))});if(e instanceof s().JsonWebTokenError)return t.status(401).json({message:"Unauthorized: Invalid token"});return t.status(500).json({message:"Internal server error",error:void 0})}}n()}catch(e){n(e)}})},47153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=94473);module.exports=r})();